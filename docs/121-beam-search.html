<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>121-beam-search</title><script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    jax: ["input/TeX","output/HTML-CSS"],
    extensions: ["[a11y]/accessibility-menu.js"],
    'HTML-CSS': {
      availableFonts: [],
      webFont: 'TeX',
      undefinedFamily: "serif",
      mtextFontInherit: true,
    },
    TeX: {
  "Macros": {},
  "equationNumbers": {
    "autoNumber": "AMS",
    "useLabelIds": false
  },
  "extensions": [
    "AMSmath.js",
    "AMSsymbols.js",
    "noErrors.js",
    "noUndefined.js",
    "AMSmath.js"
  ]
},
    showMathMenu: true
  });
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>
    <style>.emoji {
  max-width: 1em !important;
}
del {
  text-decoration: none;
  position: relative;
}
del::after {
  border-bottom: 1px solid black;
  content: '';
  left: 0;
  position: absolute;
  right: 0;
  top: 50%;
}
ul.contains-task-list li.task-list-item {
  position: relative;
  list-style-type: none;
}
ul.contains-task-list li.task-list-item input.task-list-item-checkbox {
  position: absolute;
  transform: translateX(-100%);
  width: 26px;
}
span.critic.comment {
  position: relative;
}
span.critic.comment::before {
  content: '\1f4ac';
  position: initial;
}
span.critic.comment > span {
  display: none;
}
span.critic.comment:hover > span {
  display: initial;
  position: absolute;
  top: 100%;
  left: 0;
  border: 1px solid;
  border-radius: 5px;
  max-height: 4em;
  overflow: auto;
}
span.critic.comment:focus > span {
  display: initial;
  text-decoration: underline;
  position: initial;
  top: auto;
  left: auto;
  border: initial;
  border-radius: initial;
}
table {
  border-collapse: collapse;
  border-spacing: 0;
  background-color: transparent;
}

body {
  overflow: initial !important;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  line-height: 1.6;
  word-wrap: break-word;
  padding: 30px;
  font-size: 16px;
  color: #333;
  background-color: #fff;
}
body > *:first-child {
  margin-top: 0 !important;
}
body > *:last-child {
  margin-bottom: 0 !important;
}
body a:not([href]) {
  color: inherit;
  text-decoration: none;
}
body .absent {
  color: #c00;
}
body .anchor {
  position: absolute;
  top: 0;
  left: 0;
  display: block;
  padding-right: 6px;
  padding-left: 30px;
  margin-left: -30px;
}
body .anchor:focus {
  outline: none;
}
body h1,
body h2,
body h3,
body h4,
body h5,
body h6 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}
body h1 .octicon-link,
body h2 .octicon-link,
body h3 .octicon-link,
body h4 .octicon-link,
body h5 .octicon-link,
body h6 .octicon-link {
  display: none;
  color: #000;
  vertical-align: middle;
}
body h1:hover .anchor,
body h2:hover .anchor,
body h3:hover .anchor,
body h4:hover .anchor,
body h5:hover .anchor,
body h6:hover .anchor {
  padding-left: 8px;
  margin-left: -30px;
  text-decoration: none;
}
body h1:hover .anchor .octicon-link,
body h2:hover .anchor .octicon-link,
body h3:hover .anchor .octicon-link,
body h4:hover .anchor .octicon-link,
body h5:hover .anchor .octicon-link,
body h6:hover .anchor .octicon-link {
  display: inline-block;
}
body h1 tt,
body h2 tt,
body h3 tt,
body h4 tt,
body h5 tt,
body h6 tt,
body h1 code,
body h2 code,
body h3 code,
body h4 code,
body h5 code,
body h6 code {
  font-size: inherit;
}
body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}
body h1 .anchor {
  line-height: 1;
}
body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}
body h2 .anchor {
  line-height: 1;
}
body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}
body h3 .anchor {
  line-height: 1.2;
}
body h4 {
  font-size: 1.25em;
}
body h4 .anchor {
  line-height: 1.2;
}
body h5 {
  font-size: 1em;
}
body h5 .anchor {
  line-height: 1.1;
}
body h6 {
  font-size: 1em;
  color: #777;
}
body h6 .anchor {
  line-height: 1.1;
}
body p,
body blockquote,
body ul,
body ol,
body dl,
body table,
body pre {
  margin-top: 0;
  margin-bottom: 16px;
}
body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}
body ul,
body ol {
  padding-left: 2em;
}
body ul.no-list,
body ol.no-list {
  padding: 0;
  list-style-type: none;
}
body ul ul,
body ul ol,
body ol ol,
body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}
body li > p {
  margin-top: 16px;
}
body dl {
  padding: 0;
}
body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}
body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}
body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}
body blockquote > :first-child {
  margin-top: 0;
}
body blockquote > :last-child {
  margin-bottom: 0;
}
body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}
body table th {
  font-weight: bold;
}
body table th,
body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}
body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}
body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}
body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}
body .emoji {
  max-width: none;
}
body span.frame {
  display: block;
  overflow: hidden;
}
body span.frame > span {
  display: block;
  float: left;
  width: auto;
  padding: 7px;
  margin: 13px 0 0;
  overflow: hidden;
  border: 1px solid #ddd;
}
body span.frame span img {
  display: block;
  float: left;
}
body span.frame span span {
  display: block;
  padding: 5px 0 0;
  clear: both;
  color: #333;
}
body span.align-center {
  display: block;
  overflow: hidden;
  clear: both;
}
body span.align-center > span {
  display: block;
  margin: 13px auto 0;
  overflow: hidden;
  text-align: center;
}
body span.align-center span img {
  margin: 0 auto;
  text-align: center;
}
body span.align-right {
  display: block;
  overflow: hidden;
  clear: both;
}
body span.align-right > span {
  display: block;
  margin: 13px 0 0;
  overflow: hidden;
  text-align: right;
}
body span.align-right span img {
  margin: 0;
  text-align: right;
}
body span.float-left {
  display: block;
  float: left;
  margin-right: 13px;
  overflow: hidden;
}
body span.float-left span {
  margin: 13px 0 0;
}
body span.float-right {
  display: block;
  float: right;
  margin-left: 13px;
  overflow: hidden;
}
body span.float-right > span {
  display: block;
  margin: 13px auto 0;
  overflow: hidden;
  text-align: right;
}
body code,
body tt {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0, 0, 0, 0.04);
  border-radius: 3px;
}
body code:before,
body tt:before,
body code:after,
body tt:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}
body code br,
body tt br {
  display: none;
}
body del code {
  text-decoration: inherit;
}
body pre > code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}
body .highlight {
  margin-bottom: 16px;
}
body .highlight pre,
body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}
body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}
body pre {
  word-wrap: normal;
}
body pre code,
body pre tt {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}
body pre code:before,
body pre tt:before,
body pre code:after,
body pre tt:after {
  content: normal;
}
body kbd {
  display: inline-block;
  padding: 3px 5px;
  font-size: 11px;
  line-height: 10px;
  color: #555;
  vertical-align: middle;
  background-color: #fcfcfc;
  border: solid 1px #ccc;
  border-bottom-color: #bbb;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #bbb;
}
span.critic.comment > span {
  background-color: #fff;
}
a {
  color: #337ab7;
}

pre.editor-colors {
  color: #839496;
  background-color: #002b36;
}
pre.editor-colors .gutter {
  color: #839496;
  background-color: #073642;
}
pre.editor-colors .gutter .line-number.cursor-line {
  background-color: #0a4d5e;
}
pre.editor-colors .invisible-character {
  color: #0a4d5e;
}
pre.editor-colors .indent-guide {
  color: #0a4d5e;
}
pre.editor-colors .cursor {
  border-color: #fdf6e3;
}
pre.editor-colors .cursor-line {
  background-color: rgba(0, 165, 207, 0.08);
}
pre.editor-colors .selection .region {
  background-color: #073a47;
}
pre.editor-colors .fold-marker:after,
pre.editor-colors .gutter .line-number.folded {
  color: #d33682;
}
pre.editor-colors .bracket-matcher .region {
  border-color: #d33682;
}
.syntax--comment {
  color: #586e75;
  font-style: italic;
}
.syntax--comment .syntax--markup.syntax--link {
  color: #586e75;
}
.syntax--string {
  color: #2aa198;
}
.syntax--string.syntax--regexp {
  color: #dc322f;
}
.syntax--constant.syntax--numeric {
  color: #d33682;
}
.syntax--constant.syntax--language {
  color: #b58900;
}
.syntax--constant.syntax--character,
.syntax--constant.syntax--other,
.syntax--constant.syntax--support {
  color: #cb4b16;
}
.syntax--variable {
  color: #268bd2;
}
.syntax--keyword {
  color: #859900;
}
.syntax--storage {
  color: #859900;
}
.syntax--meta.syntax--class {
  color: #268bd2;
}
.syntax--entity.syntax--name.syntax--class,
.syntax--entity.syntax--name.syntax--function,
.syntax--entity.syntax--name.syntax--section,
.syntax--entity.syntax--name.syntax--type {
  color: #268bd2;
}
.syntax--entity.syntax--other.syntax--attribute-name {
  color: #657b83;
}
.syntax--support.syntax--function {
  color: #268bd2;
}
.syntax--support.syntax--function.syntax--builtin {
  color: #859900;
}
.syntax--support.syntax--type,
.syntax--support.syntax--class {
  color: #859900;
}
.syntax--tag.syntax--entity.syntax--name {
  color: #268bd2;
}
.syntax--tag.syntax--punctuation.syntax--definition.syntax--html,
.syntax--tag.syntax--punctuation.syntax--definition.syntax--begin,
.syntax--tag.syntax--punctuation.syntax--definition.syntax--end {
  color: #586e75;
}
.syntax--invalid.syntax--deprecated {
  color: #b58900;
  text-decoration: underline;
}
.syntax--invalid.syntax--illegal {
  color: #dc322f;
  text-decoration: underline;
}
.syntax--none {
  color: #839496;
}
.syntax--source.syntax--c .syntax--meta.syntax--preprocessor,
.syntax--source.syntax--cpp .syntax--meta.syntax--preprocessor {
  color: #dc322f;
}
.syntax--source.syntax--c .syntax--keyword.syntax--control.syntax--directive,
.syntax--source.syntax--cpp .syntax--keyword.syntax--control.syntax--directive {
  color: #cb4b16;
}
.syntax--source.syntax--c .syntax--punctuation.syntax--string,
.syntax--source.syntax--cpp .syntax--punctuation.syntax--string {
  color: #2aa198;
}
.syntax--source.syntax--c .syntax--constant,
.syntax--source.syntax--cpp .syntax--constant {
  color: #cb4b16;
}
.syntax--source.syntax--c .syntax--constant.syntax--numeric,
.syntax--source.syntax--cpp .syntax--constant.syntax--numeric,
.syntax--source.syntax--c .syntax--constant.syntax--language.syntax--c,
.syntax--source.syntax--cpp .syntax--constant.syntax--language.syntax--c {
  color: #2aa198;
}
.syntax--source.syntax--c .syntax--storage,
.syntax--source.syntax--cpp .syntax--storage {
  color: #b58900;
}
.syntax--source.syntax--c .syntax--entity,
.syntax--source.syntax--cpp .syntax--entity {
  color: #839496;
}
.syntax--source.syntax--c .syntax--entity.syntax--name.syntax--function.syntax--preprocessor,
.syntax--source.syntax--cpp .syntax--entity.syntax--name.syntax--function.syntax--preprocessor {
  color: #dc322f;
}
.syntax--source.syntax--c .syntax--support.syntax--type,
.syntax--source.syntax--cpp .syntax--support.syntax--type {
  color: #b58900;
}
.syntax--source.syntax--c .syntax--support.syntax--type.syntax--posix-reserved,
.syntax--source.syntax--cpp .syntax--support.syntax--type.syntax--posix-reserved {
  color: #839496;
}
.syntax--source.syntax--c .syntax--variable.syntax--other.syntax--dot-access,
.syntax--source.syntax--cpp .syntax--variable.syntax--other.syntax--dot-access {
  color: #839496;
}
.syntax--source.syntax--c .syntax--variable.syntax--parameter.syntax--preprocessor,
.syntax--source.syntax--cpp .syntax--variable.syntax--parameter.syntax--preprocessor {
  color: #dc322f;
}
.syntax--source.syntax--coffee .syntax--support.syntax--class {
  color: #859900;
}
.syntax--source.syntax--coffee .syntax--variable,
.syntax--source.syntax--coffee .syntax--entity.syntax--name.syntax--function,
.syntax--source.syntax--coffee .syntax--entity.syntax--name.syntax--class {
  color: #268bd2;
}
.syntax--source.syntax--coffee .syntax--variable.syntax--parameter.syntax--function {
  color: #839496;
}
.syntax--source.syntax--coffee .syntax--variable.syntax--other.syntax--readwrite {
  color: #859900;
}
.syntax--source.syntax--coffee .syntax--storage.syntax--type.syntax--function {
  color: #859900;
}
.syntax--source.syntax--coffee .syntax--entity.syntax--name {
  color: #839496;
}
.syntax--source.syntax--coffee .syntax--meta.syntax--brace.syntax--round,
.syntax--source.syntax--coffee .syntax--meta.syntax--brace.syntax--square {
  color: #839496;
}
.syntax--source.syntax--coffee .syntax--meta.syntax--delimiter {
  color: #839496;
}
.syntax--source.syntax--coffee .syntax--storage.syntax--type.syntax--class {
  color: #859900;
}
.syntax--source.syntax--coffee .syntax--punctuation.syntax--terminator {
  color: #839496;
}
.syntax--source.syntax--coffee .syntax--punctuation.syntax--section.syntax--embedded {
  color: #dc322f;
}
.syntax--source.syntax--coffee .syntax--embedded.syntax--source {
  color: #839496;
}
.syntax--source.syntax--coffee .syntax--constant.syntax--numeric {
  color: #d33682;
}
.syntax--source.syntax--coffee .syntax--constant.syntax--language.syntax--boolean {
  color: #b58900;
}
.syntax--source.syntax--css .syntax--punctuation.syntax--separator,
.syntax--source.syntax--css .syntax--punctuation.syntax--terminator {
  color: #839496;
}
.syntax--source.syntax--css .syntax--punctuation.syntax--property-list.syntax--begin,
.syntax--source.syntax--css .syntax--punctuation.syntax--property-list.syntax--end {
  color: #dc322f;
}
.syntax--source.syntax--css .syntax--punctuation.syntax--section.syntax--function {
  color: #2aa198;
}
.syntax--source.syntax--css .syntax--entity.syntax--name {
  color: #859900;
}
.syntax--source.syntax--css .syntax--attribute-name.syntax--class,
.syntax--source.syntax--css .syntax--id {
  color: #268bd2;
}
.syntax--source.syntax--css .syntax--pseudo-element,
.syntax--source.syntax--css .syntax--pseudo-class {
  color: #cb4b16;
}
.syntax--source.syntax--css .syntax--property-value {
  color: #2aa198;
}
.syntax--source.syntax--css .syntax--constant.syntax--numeric {
  color: #2aa198;
}
.syntax--source.syntax--css .syntax--constant.syntax--numeric .syntax--unit {
  color: #2aa198;
}
.syntax--source.syntax--css .syntax--rgb-value {
  color: #2aa198;
}
.syntax--source.syntax--css .syntax--support.syntax--constant {
  color: #2aa198;
}
.syntax--source.syntax--css .syntax--support.syntax--constant.syntax--media {
  color: #dc322f;
}
.syntax--source.syntax--css .syntax--keyword.syntax--important {
  color: #dc322f;
}
.syntax--source.syntax--less .syntax--keyword.syntax--unit,
.syntax--source.syntax--scss .syntax--keyword.syntax--unit {
  color: #2aa198;
}
.syntax--source.syntax--go .syntax--operator {
  color: #839496;
}
.syntax--source.syntax--go .syntax--operator.syntax--assignment {
  color: #859900;
}
.syntax--source.syntax--java .syntax--keyword.syntax--operator {
  color: #859900;
}
.syntax--source.syntax--java .syntax--keyword.syntax--import {
  color: #cb4b16;
}
.syntax--source.syntax--java .syntax--storage.syntax--modifier.syntax--import {
  color: #586e75;
}
.syntax--source.syntax--java .syntax--meta.syntax--class .syntax--storage.syntax--modifier {
  color: #b58900;
}
.syntax--source.syntax--java .syntax--meta.syntax--class .syntax--meta.syntax--class.syntax--identifier .syntax--entity.syntax--name.syntax--type.syntax--class {
  color: #268bd2;
}
.syntax--source.syntax--java .syntax--storage.syntax--type.syntax--primitive.syntax--array {
  color: #859900;
}
.syntax--source.syntax--java .syntax--constant.syntax--numeric {
  color: #d33682;
}
.syntax--source.syntax--java .syntax--constant.syntax--other {
  color: #cb4b16;
}
.syntax--source.syntax--java .syntax--storage.syntax--type {
  color: #859900;
}
.syntax--source.syntax--java .syntax--meta.syntax--method-call {
  color: #dc322f;
}
.syntax--source.syntax--java .syntax--meta.syntax--method-call .syntax--meta.syntax--method {
  color: #6c71c4;
}
.syntax--source.syntax--java .syntax--meta.syntax--method-call .syntax--punctuation.syntax--definition.syntax--seperator.syntax--parameter {
  color: #859900;
}
.syntax--source.syntax--java .syntax--punctuation.syntax--definition.syntax--method-parameters {
  color: #93a1a1;
}
.syntax--source.syntax--js .syntax--comma {
  color: #839496;
}
.syntax--source.syntax--js .syntax--support.syntax--class {
  color: #859900;
}
.syntax--source.syntax--js .syntax--entity.syntax--name.syntax--type {
  color: #b58900;
}
.syntax--source.syntax--js .syntax--entity.syntax--name {
  color: #839496;
}
.syntax--source.syntax--js .syntax--entity.syntax--name.syntax--function {
  color: #268bd2;
}
.syntax--source.syntax--js .syntax--entity.syntax--name.syntax--tag {
  color: #268bd2;
}
.syntax--source.syntax--js .syntax--entity.syntax--other.syntax--attribute-name {
  color: #b58900;
}
.syntax--source.syntax--js .syntax--meta.syntax--brace {
  color: #839496;
}
.syntax--source.syntax--js .syntax--keyword {
  color: #839496;
}
.syntax--source.syntax--js .syntax--keyword.syntax--operator.syntax--new {
  color: #859900;
}
.syntax--source.syntax--js .syntax--keyword.syntax--control {
  color: #cb4b16;
}
.syntax--source.syntax--js .syntax--keyword.syntax--control.syntax--regexp {
  color: #2aa198;
}
.syntax--source.syntax--js .syntax--variable {
  color: #839496;
}
.syntax--source.syntax--js .syntax--variable.syntax--dom {
  color: #859900;
}
.syntax--source.syntax--js .syntax--delimiter + .syntax--dom {
  color: #839496;
}
.syntax--source.syntax--js .syntax--name {
  color: #839496;
}
.syntax--source.syntax--js .syntax--variable.syntax--language {
  color: #268bd2;
}
.syntax--source.syntax--js .syntax--variable.syntax--parameter {
  color: #839496;
}
.syntax--source.syntax--js .syntax--regexp {
  color: #2aa198;
}
.syntax--source.syntax--js .syntax--support.syntax--function {
  color: #839496;
}
.syntax--source.syntax--js .syntax--support.syntax--constant {
  color: #839496;
}
.syntax--source.syntax--js .syntax--storage.syntax--modifier {
  color: #b58900;
}
.syntax--source.syntax--js .syntax--punctuation.syntax--terminator.syntax--statement {
  color: #839496;
}
.syntax--source.syntax--js .syntax--meta.syntax--delimiter.syntax--method.syntax--period {
  color: #839496;
}
.syntax--source.syntax--js .syntax--meta.syntax--brace.syntax--square {
  color: #268bd2;
}
.syntax--source.syntax--js .syntax--meta.syntax--brace.syntax--curly {
  color: #268bd2;
}
.syntax--source.syntax--js .syntax--string.syntax--quoted.syntax--template .syntax--embedded.syntax--source {
  color: #839496;
}
.syntax--source.syntax--js .syntax--string.syntax--quoted.syntax--template .syntax--embedded.syntax--source > .syntax--embedded.syntax--punctuation {
  color: #dc322f;
}
.syntax--source.syntax--js.syntax--embedded .syntax--entity.syntax--name.syntax--tag {
  color: #268bd2;
}
.syntax--source.syntax--js .syntax--import .syntax--control {
  color: #cb4b16;
}
.syntax--source.syntax--js.syntax--rails .syntax--instance {
  color: #268bd2;
}
.syntax--source.syntax--js.syntax--rails .syntax--class {
  color: #b58900;
}
.syntax--md .syntax--link .syntax--entity,
.syntax--gfm .syntax--link .syntax--entity {
  color: #6c71c4;
}
.syntax--md .syntax--list.syntax--ordered,
.syntax--gfm .syntax--list.syntax--ordered {
  color: #859900;
}
.syntax--md .syntax--list.syntax--unordered,
.syntax--gfm .syntax--list.syntax--unordered {
  color: #b58900;
}
.syntax--md .syntax--raw,
.syntax--gfm .syntax--raw {
  font-style: italic;
}
.syntax--md.syntax--support,
.syntax--gfm.syntax--support {
  color: #586e75;
}
.syntax--md.syntax--support.syntax--quote,
.syntax--gfm.syntax--support.syntax--quote {
  color: #6c71c4;
}
.syntax--markup.syntax--bold {
  font-weight: bold;
}
.syntax--markup.syntax--italic {
  font-style: italic;
}
.syntax--markup.syntax--heading {
  color: #268bd2;
}
.syntax--markup.syntax--link {
  color: #2aa198;
}
.syntax--markup.syntax--deleted {
  color: #dc322f;
}
.syntax--markup.syntax--changed {
  color: #b58900;
}
.syntax--markup.syntax--inserted {
  color: #2aa198;
}
.syntax--source.syntax--php .syntax--storage.syntax--type.syntax--class {
  color: #b58900;
}
.syntax--source.syntax--php .syntax--storage.syntax--type.syntax--function {
  color: #cb4b16;
}
.syntax--source.syntax--php .syntax--storage.syntax--modifier {
  color: #b58900;
}
.syntax--source.syntax--php .syntax--entity.syntax--name.syntax--type.syntax--class {
  color: #839496;
}
.syntax--source.syntax--php .syntax--entity.syntax--name.syntax--function {
  color: #839496;
}
.syntax--source.syntax--php .syntax--entity.syntax--other {
  color: #839496;
}
.syntax--source.syntax--php .syntax--variable {
  color: #268bd2;
}
.syntax--source.syntax--php .syntax--punctuation.syntax--definition {
  color: #839496;
}
.syntax--source.syntax--php .syntax--punctuation.syntax--definition.syntax--comment {
  color: #586e75;
}
.syntax--source.syntax--php .syntax--punctuation.syntax--definition.syntax--array {
  color: #dc322f;
}
.syntax--source.syntax--php .syntax--punctuation.syntax--definition.syntax--string {
  color: #839496;
}
.syntax--source.syntax--php .syntax--punctuation.syntax--definition.syntax--variable {
  color: #859900;
}
.syntax--source.syntax--php .syntax--support.syntax--function.syntax--construct {
  color: #b58900;
}
.syntax--source.syntax--php .syntax--support.syntax--function.syntax--array {
  color: #859900;
}
.syntax--source.syntax--php .syntax--keyword.syntax--operator.syntax--class {
  color: #b58900;
}
.syntax--source.syntax--php .syntax--keyword.syntax--operator.syntax--assignment {
  color: #859900;
}
.syntax--source.syntax--php .syntax--keyword.syntax--other {
  color: #dc322f;
}
.syntax--source.syntax--python .syntax--entity {
  color: #839496;
}
.syntax--source.syntax--python .syntax--entity.syntax--name {
  color: #268bd2;
}
.syntax--source.syntax--python .syntax--entity.syntax--other {
  color: #268bd2;
}
.syntax--source.syntax--python .syntax--function {
  color: #268bd2;
}
.syntax--source.syntax--python .syntax--function.syntax--magic {
  color: #268bd2;
}
.syntax--source.syntax--python .syntax--punctuation.syntax--string {
  color: #2aa198;
}
.syntax--source.syntax--python .syntax--keyword.syntax--operator {
  color: #839496;
}
.syntax--source.syntax--python .syntax--keyword.syntax--operator.syntax--quantifier {
  color: #2aa198;
}
.syntax--source.syntax--python .syntax--keyword.syntax--operator.syntax--logical {
  color: #859900;
}
.syntax--source.syntax--python .syntax--keyword.syntax--control.syntax--import {
  color: #cb4b16;
}
.syntax--source.syntax--python .syntax--keyword.syntax--other {
  color: #859900;
}
.syntax--source.syntax--python .syntax--constant.syntax--language {
  color: #268bd2;
}
.syntax--source.syntax--python .syntax--constant.syntax--character {
  color: #2aa198;
}
.syntax--source.syntax--python .syntax--constant.syntax--other {
  color: #dc322f;
}
.syntax--source.syntax--python .syntax--entity.syntax--name.syntax--type.syntax--class {
  color: #268bd2;
}
.syntax--source.syntax--python .syntax--variable {
  color: #839496;
}
.syntax--source.syntax--python .syntax--support.syntax--function.syntax--builtin {
  color: #268bd2;
}
.syntax--source.syntax--python .syntax--support.syntax--type.syntax--exception.syntax--python {
  color: #b58900;
}
.syntax--source.syntax--python .syntax--support.syntax--type.syntax--python {
  color: #268bd2;
}
.syntax--source.syntax--python .syntax--storage.syntax--type.syntax--string {
  color: #2aa198;
}
.syntax--source.syntax--python .syntax--storage.syntax--type.syntax--class {
  color: #859900;
}
.syntax--source.syntax--python .syntax--storage.syntax--type.syntax--class.syntax--todo {
  color: #d33682;
}
.syntax--source.syntax--python .syntax--storage.syntax--type.syntax--function {
  color: #859900;
}
.syntax--source.syntax--python .syntax--punctuation.syntax--definition.syntax--parameters {
  color: #839496;
}
.syntax--source.syntax--python .syntax--punctuation.syntax--section.syntax--function.syntax--begin {
  color: #839496;
}
.syntax--source.syntax--python .syntax--punctuation.syntax--separator.syntax--parameters {
  color: #839496;
}
.syntax--source.syntax--ruby .syntax--meta.syntax--embedded .syntax--punctuation.syntax--section {
  color: #dc322f;
}
.syntax--source.syntax--ruby .syntax--punctuation.syntax--definition {
  color: #839496;
}
.syntax--source.syntax--ruby .syntax--punctuation.syntax--definition.syntax--string {
  color: #dc322f;
}
.syntax--source.syntax--ruby .syntax--punctuation.syntax--definition.syntax--comment {
  color: #586e75;
}
.syntax--source.syntax--ruby .syntax--entity.syntax--inherited-class {
  color: #b58900;
}
.syntax--source.syntax--ruby .syntax--variable.syntax--parameter {
  color: #839496;
}
.syntax--source.syntax--ruby .syntax--variable.syntax--constant {
  color: #b58900;
}
.syntax--source.syntax--ruby .syntax--constant.syntax--boolean {
  color: #2aa198;
}
.syntax--source.syntax--ruby .syntax--instance .syntax--punctuation.syntax--definition {
  color: #268bd2;
}
.syntax--source.syntax--ruby .syntax--class {
  color: #b58900;
}
.syntax--source.syntax--ruby .syntax--class.syntax--control {
  color: #839496;
}
.syntax--source.syntax--ruby .syntax--module {
  color: #b58900;
}
.syntax--source.syntax--ruby .syntax--require .syntax--keyword.syntax--other.syntax--special-method {
  color: #cb4b16;
}
.syntax--source.syntax--ruby .syntax--keyword.syntax--other.syntax--special-method {
  color: #cb4b16;
}
.syntax--source.syntax--ruby .syntax--keyword.syntax--other {
  color: #859900;
}
.syntax--source.syntax--ruby .syntax--keyword.syntax--control {
  color: #859900;
}
.syntax--source.syntax--ruby .syntax--keyword.syntax--operator {
  color: #839496;
}
.syntax--source.syntax--ruby .syntax--special-method {
  color: #268bd2;
}
.syntax--source.syntax--ruby .syntax--symbol {
  color: #2aa198;
}
.syntax--source.syntax--ruby .syntax--symbol .syntax--punctuation.syntax--definition {
  color: #2aa198;
}
.syntax--source.syntax--ruby .syntax--hashkey {
  color: #dc322f;
}
.syntax--source.syntax--ruby .syntax--hashkey .syntax--punctuation.syntax--definition {
  color: #dc322f;
}
.syntax--source.syntax--ruby .syntax--string.syntax--regexp {
  color: #dc322f;
}
.syntax--source.syntax--ruby .syntax--todo {
  color: #d33682;
}
.syntax--source.syntax--ruby .syntax--variable.syntax--ruby.syntax--global {
  color: #268bd2;
}
.syntax--source.syntax--ruby .syntax--variable.syntax--ruby.syntax--global .syntax--punctuation {
  color: #268bd2;
}
.syntax--source.syntax--ruby .syntax--variable.syntax--block {
  color: #268bd2;
}
.syntax--source.syntax--ruby .syntax--variable.syntax--self {
  color: #2aa198;
}
.syntax--source.syntax--ruby .syntax--punctuation.syntax--separator {
  color: #839496;
}
.syntax--source.syntax--ruby .syntax--numeric {
  color: #2aa198;
}
.syntax--source.syntax--ruby .syntax--punctuation.syntax--section.syntax--regexp {
  color: #dc322f;
}
.syntax--source.syntax--ruby .syntax--string.syntax--interpolated {
  color: #2aa198;
}
.syntax--source.syntax--ruby .syntax--string.syntax--interpolated .syntax--embedded.syntax--line.syntax--ruby .syntax--punctuation .syntax--source.syntax--ruby {
  color: #dc322f;
}
.syntax--source.syntax--ruby .syntax--string.syntax--interpolated .syntax--embedded.syntax--line.syntax--ruby .syntax--source.syntax--ruby {
  color: #839496;
}
.syntax--source.syntax--ruby .syntax--string.syntax--interpolated .syntax--embedded.syntax--line.syntax--ruby .syntax--source.syntax--ruby .syntax--punctuation.syntax--array,
.syntax--source.syntax--ruby .syntax--string.syntax--interpolated .syntax--embedded.syntax--line.syntax--ruby .syntax--source.syntax--ruby .syntax--punctuation.syntax--function {
  color: #839496;
}
.syntax--source.syntax--ruby .syntax--support.syntax--function {
  color: #839496;
}
.syntax--source.syntax--ruby .syntax--support.syntax--function.syntax--kernel {
  color: #859900;
}
.syntax--source.syntax--scala .syntax--variable {
  color: #93a1a1;
}
.syntax--source.syntax--scala .syntax--declaration {
  color: #93a1a1;
  font-weight: bold;
}
.syntax--source.syntax--scala .syntax--comparison {
  color: #93a1a1;
}
.syntax--source.syntax--scala .syntax--class,
.syntax--source.syntax--scala .syntax--type {
  color: #b58900;
}
.syntax--source.syntax--scala .syntax--val {
  font-weight: normal;
}
.syntax--source.syntax--scala .syntax--variable {
  font-weight: bold;
}
.syntax--source.syntax--scala .syntax--variable.syntax--parameter {
  color: #6c71c4;
  font-weight: normal;
}
.syntax--source.syntax--scala .syntax--control.syntax--flow {
  color: #93a1a1;
  font-weight: bold;
}
.syntax--source.syntax--scala .syntax--constant.syntax--language {
  color: #93a1a1;
  font-weight: bold;
}
.syntax--source.syntax--scala .syntax--function.syntax--declaration {
  color: #6c71c4;
}
.syntax--source.syntax--scala .syntax--modifier.syntax--other {
  font-weight: bold;
}
.syntax--source.syntax--scala .syntax--package {
  color: #93a1a1;
}
.syntax--source.syntax--scala .syntax--variable.syntax--import {
  font-weight: normal;
}
.syntax--source.syntax--scala .syntax--type .syntax--bounds,
.syntax--source.syntax--scala .syntax--type .syntax--class {
  color: #6c71c4;
}
.syntax--source.syntax--scala .syntax--documentation :not(.syntax--embedded).syntax--link.syntax--entity {
  color: #268bd2;
  text-decoration: underline;
}
.syntax--source.syntax--scala .syntax--documentation :not(.syntax--embedded) .syntax--class,
.syntax--source.syntax--scala .syntax--documentation :not(.syntax--embedded) .syntax--parameter {
  color: #93a1a1;
}
.syntax--source.syntax--scala .syntax--documentation :not(.syntax--embedded) .syntax--description {
  color: #586e75;
}
.syntax--source.syntax--scala .syntax--embedded {
  color: #6c7c7c;
  font-style: italic;
}
.syntax--source.syntax--scala .syntax--embedded .syntax--margin,
.syntax--source.syntax--scala .syntax--embedded .syntax--delimiters {
  font-style: normal;
}
.syntax--source.syntax--ts .syntax--import .syntax--control,
.syntax--source.syntax--tsx .syntax--import .syntax--control {
  color: #cb4b16;
}
.syntax--source.syntax--ts .syntax--entity.syntax--name.syntax--type,
.syntax--source.syntax--tsx .syntax--entity.syntax--name.syntax--type {
  color: #b58900;
}
.syntax--source.syntax--ts .syntax--entity.syntax--inherited-class,
.syntax--source.syntax--tsx .syntax--entity.syntax--inherited-class {
  color: #b58900;
}
.syntax--source.syntax--ts .syntax--support.syntax--type,
.syntax--source.syntax--tsx .syntax--support.syntax--type {
  color: #b58900;
}

/*
 * Your Stylesheet
 *
 * This stylesheet is loaded when Atom starts up and is reloaded automatically
 * when it is changed and saved.
 *
 * Add your own CSS or Less to fully customize Atom.
 * If you are unfamiliar with Less, you can read more about it here:
 * http://lesscss.org
 */
/*
 * Examples
 * (To see them, uncomment and save)
 */
</style>

  </head>
  <body>
    <h1>Beam search</h1>
<ul>
<li>Beam search is the most widely used algorithm to get the best output sequence. It’s a heuristic search algorithm.</li>
<li>To illustrate the algorithm we will use the example below. We need Y = "Jane is visiting Africa in September.</li>
</ul>
<p><img src="images\121-beam-search-32dee0ff.png" alt=""></p>
<ul>
<li>The algorithm has a parameter <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">B</code>  which is the beam width. Lets take <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">B = 3</code> which means the algorithm will get 3 outputs at a time.</li>
<li>For the first step you will get [“in”, “jane”, “september”] words that are the best candidates.</li>
<li><img src="images\121-beam-search-f114fed9.png" alt=""></li>
<li>Then for each word in the first output, get B next (second) words and select top best B combinations where the best are those what give the highest value of multiplying both probabilities - <span class="math"><script type="math/tex">\prod_{t=1}^{T_y}p(y^{<t>}|x,y^{<1>}, \cdots, y^{<t-1>})=P(\hat{y}^{<1>}|x) * P(\hat{y}^{<2>}|x,\hat{y}^{<1>})* \cdots *P(\hat{y}^{<t>}|x,\hat{y}^{<t-1>})</script></span>. in other words,
arg <span class="math"><script type="math/tex">max_{y}\prod_{t=1}^{T_y}p(y^{<t>}|x,y^{<1>}, \cdots, y^{<t-1>})</script></span></li>
</ul>
<p>We will have then [“in september”, “jane is”, “jane visit”]. These three words are kept in the memory.</p>
<p><img src="images\121-beam-search-a85ff417.png" alt="">
<img src="images\121-beam-search-19716c50.png" alt="">
Notice, that we automatically discard <em>september</em> as a first word.</p>
<ul>
<li>Repeat the same process and get the best B words for [“september”, “is”, “visit”]  and so on.</li>
<li>In this algorithm, keep only B instances of your network.</li>
<li>If <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">B = 1</code> this will become the greedy search.
<img src="images\121-beam-search-2b47cdbc.png" alt=""></li>
</ul>
<h2>Refinements to Beam Search</h2>
<h3>Length normalization</h3>
<ul>
<li>Length normalization is a small change to the beam search algorithm that can help you get much better results.</li>
<li>Since beam search is the product of probabilities (&gt;=1), so it will results in a very small number.</li>
</ul>
<p>arg <span class="math"><script type="math/tex">max_{y}\prod_{t=1}^{T_y}p(y^{<t>}|x,y^{<1>}, \cdots, y^{<t-1>})</script></span></p>
<ul>
<li>SO, maximizing the sum of log probabilities would be a better option.</li>
</ul>
<p>arg <span class="math"><script type="math/tex">max_{y}\sum_{y=1}^{T_y}\log p(y^{<t>}|x,y^{<1>}, \cdots, y{<t-1>})</script></span></p>
<ul>
<li>The log of our probability is always less than or equal to 1. So the more terms you have together, the more negative this becomes.</li>
<li>There’s one other change to the algorithm that makes it work better, which is instead of using <span class="math"><script type="math/tex">\sum_{y=1}^{T_y}\log p(y^{<t>}|x,y^{<1>}, \cdots, y{<t-1>})</script></span> as the objective you’re trying to maximize, one thing you could do is normalize this by the number of words in your translation.</li>
</ul>
<p><span class="math"><script type="math/tex">\frac{1}{T}\sum_{y=1}^{T_y}\log p(y^{<t>}|x,y^{<1>}, \cdots, y{<t-1>})</script></span></p>
<p>In practice, slightly softer approach may be taken with addition of <span class="math"><script type="math/tex">\alpha</script></span>
<span class="math"><script type="math/tex">\frac{1}{T}^{\alpha}\sum_{y=1}^{T_y}\log p(y^{<t>}|x,y^{<1>}, \cdots, y{<t-1>})</script></span> where <span class="math"><script type="math/tex">\alpha</script></span> is around 0.7 in practice.</p>
<ul>
<li>alpha is a hyperparameter to tune.</li>
<li>If alpha = 0 - no sequence length normalization.</li>
<li>If alpha = 1 - full sequence length normalization.</li>
<li>In practice alpha = 0.7 is a good thing (somewhere in between two extremes).</li>
</ul>
<hr>
<ul>
<li>
<p>The second thing is how can we choose best B?</p>
<ul>
<li>The larger B - the larger possibilities, the better are the results. But it will be more computationally expensive.</li>
<li>In practice, you might see in the production setting B=10</li>
<li>B=100, B=1000 are uncommon (sometimes used in research settings)</li>
<li>Unlike exact search algorithms like BFS (Breadth First Search) or DFS (Depth First Search), Beam Search runs faster but is not guaranteed to find the exact solution.</li>
</ul>
</li>
<li>
<p>Unlike exact search alrogithms like BFS or DFS, Beam Search runs faster but is not guaranteed to find exact maximum for arg <span class="math"><script type="math/tex">max_y P(y|x)</script></span></p>
</li>
</ul>
<h2>Beam-search algorithm in Python</h2>
<p>See <a href="./beam-search/readme.md">here</a></p>
<pre class="editor-colors lang-Python"><span><span class="syntax--source syntax--python"><span class="syntax--comment syntax--line"># coding: utf-8</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted">"""</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted">Beam search for neural network sequence to sequence (encoder-decoder) models.</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted">Usage example:</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted">from beam_search import beam_search</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"># Load model and vocabularies...</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted">input_text = "Hello World !"</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted">X = [encoder_vocabulary.get(t, encoder_vocabulary['&lt;UNK&gt;']) for t in input_text.split()]</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted">hypotheses = beam_search(model.initial_state_function, model.generate_function, X, decoder_vocabulary['&lt;S&gt;'], decoder_vocabulary['&lt;/S&gt;'])</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted">for hypothesis in hypotheses:</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">    </span>generated_indices = hypothesis.to_sequence_of_values()</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">    </span>generated_tokens = [reverse_decoder_vocabulary[i] for i in generated_indices]</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">    </span>print(" ".join(generated_tokens))</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted">"""</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--keyword syntax--control">import</span> numpy <span class="syntax--keyword syntax--control">as</span> np</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--storage syntax--type syntax--class">class</span> <span class="syntax--entity syntax--name syntax--type syntax--class">Node</span>(object):</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span><span class="syntax--storage syntax--type syntax--function">def</span> <span class="syntax--entity syntax--name syntax--function">__init__</span>(self, parent, state, value, cost, extras):</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span><span class="syntax--entity syntax--name syntax--function">super</span>(Node, self).<span class="syntax--entity syntax--name syntax--function">__init__</span>()</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>self.<span class="syntax--variable syntax--other syntax--object syntax--property">value</span> <span class="syntax--keyword syntax--operator">=</span> value</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>self.<span class="syntax--variable syntax--other syntax--object syntax--property">parent</span> <span class="syntax--keyword syntax--operator">=</span> parent <span class="syntax--comment syntax--line"># parent Node, None for root</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>self.<span class="syntax--variable syntax--other syntax--object syntax--property">state</span> <span class="syntax--keyword syntax--operator">=</span> state.<span class="syntax--entity syntax--name syntax--function">flatten</span>() <span class="syntax--keyword syntax--control">if</span> state <span class="syntax--keyword syntax--operator syntax--logical syntax--python">is</span> <span class="syntax--keyword syntax--operator syntax--logical syntax--python">not</span> <span class="syntax--constant syntax--language">None</span> <span class="syntax--keyword syntax--control">else</span> <span class="syntax--constant syntax--language">None</span> <span class="syntax--comment syntax--line"># recurrent layer hidden state</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>self.<span class="syntax--variable syntax--other syntax--object syntax--property">cum_cost</span> <span class="syntax--keyword syntax--operator">=</span> parent.<span class="syntax--variable syntax--other syntax--object syntax--property">cum_cost</span> <span class="syntax--keyword syntax--operator">+</span> cost <span class="syntax--keyword syntax--control">if</span> parent <span class="syntax--keyword syntax--control">else</span> cost <span class="syntax--comment syntax--line"># e.g. -log(p) of sequence up to current node (including)</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>self.<span class="syntax--variable syntax--other syntax--object syntax--property">length</span> <span class="syntax--keyword syntax--operator">=</span> <span class="syntax--constant syntax--language">1</span> <span class="syntax--keyword syntax--control">if</span> parent <span class="syntax--keyword syntax--operator syntax--logical syntax--python">is</span> <span class="syntax--constant syntax--language">None</span> <span class="syntax--keyword syntax--control">else</span> parent.<span class="syntax--variable syntax--other syntax--object syntax--property">length</span> <span class="syntax--keyword syntax--operator">+</span> <span class="syntax--constant syntax--language">1</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>self.<span class="syntax--variable syntax--other syntax--object syntax--property">extras</span> <span class="syntax--keyword syntax--operator">=</span> extras <span class="syntax--comment syntax--line"># can hold, for example, attention weights</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>self.<span class="syntax--variable syntax--other syntax--object syntax--property">_sequence</span> <span class="syntax--keyword syntax--operator">=</span> <span class="syntax--constant syntax--language">None</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span><span class="syntax--storage syntax--type syntax--function">def</span> <span class="syntax--entity syntax--name syntax--function">to_sequence</span>(self):</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span><span class="syntax--comment syntax--line"># Return sequence of nodes from root to current node.</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span><span class="syntax--keyword syntax--control">if</span> <span class="syntax--keyword syntax--operator syntax--logical syntax--python">not</span> self.<span class="syntax--variable syntax--other syntax--object syntax--property">_sequence</span>:</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">            </span>self.<span class="syntax--variable syntax--other syntax--object syntax--property">_sequence</span> <span class="syntax--keyword syntax--operator">=</span> []</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">            </span>current_node <span class="syntax--keyword syntax--operator">=</span> self</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">            </span><span class="syntax--keyword syntax--control">while</span> current_node:</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">                </span>self.<span class="syntax--variable syntax--other syntax--object syntax--property">_sequence</span>.<span class="syntax--entity syntax--name syntax--function">insert</span>(<span class="syntax--constant syntax--language">0</span>, current_node)</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">                </span>current_node <span class="syntax--keyword syntax--operator">=</span> current_node.<span class="syntax--variable syntax--other syntax--object syntax--property">parent</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span><span class="syntax--keyword syntax--control">return</span> self.<span class="syntax--variable syntax--other syntax--object syntax--property">_sequence</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span><span class="syntax--storage syntax--type syntax--function">def</span> <span class="syntax--entity syntax--name syntax--function">to_sequence_of_values</span>(self):</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span><span class="syntax--keyword syntax--control">return</span> [s.<span class="syntax--variable syntax--other syntax--object syntax--property">value</span> <span class="syntax--keyword syntax--control">for</span> s <span class="syntax--keyword syntax--operator syntax--logical syntax--python">in</span> self.<span class="syntax--entity syntax--name syntax--function">to_sequence</span>()]</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span><span class="syntax--storage syntax--type syntax--function">def</span> <span class="syntax--entity syntax--name syntax--function">to_sequence_of_extras</span>(self):</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span><span class="syntax--keyword syntax--control">return</span> [s.<span class="syntax--variable syntax--other syntax--object syntax--property">extras</span> <span class="syntax--keyword syntax--control">for</span> s <span class="syntax--keyword syntax--operator syntax--logical syntax--python">in</span> self.<span class="syntax--entity syntax--name syntax--function">to_sequence</span>()]</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--storage syntax--type syntax--function">def</span> <span class="syntax--entity syntax--name syntax--function">beam_search</span>(initial_state_function, generate_function, X, start_id, end_id, beam_width<span class="syntax--keyword syntax--operator">=</span><span class="syntax--constant syntax--language">4</span>, num_hypotheses<span class="syntax--keyword syntax--operator">=</span><span class="syntax--constant syntax--language">1</span>, max_length<span class="syntax--keyword syntax--operator">=</span><span class="syntax--constant syntax--language">50</span>):</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span><span class="syntax--string syntax--quoted">"""Beam search for neural network sequence to sequence (encoder-decoder) models.</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">    </span>:param initial_state_function: A function that takes X as input and returns state (2-dimensonal numpy array with 1 row</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">                                   </span>representing decoder recurrent layer state - currently supports only one recurrent layer).</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">    </span>:param generate_function: A function that takes X, Y_tm1 (1-dimensional numpy array of token indices in decoder vocabulary</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">                              </span>generated at previous step) and state_tm1 (2-dimensonal numpy array of previous step decoder recurrent</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">                              </span>layer states) as input and returns state_t (2-dimensonal numpy array of current step decoder recurrent</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">                              </span>layer states), p_t (2-dimensonal numpy array of decoder softmax outputs) and optional extras</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">                              </span>(e.g. attention weights at current step).</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">    </span>:param X: List of input token indices in encoder vocabulary.</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">    </span>:param start_id: Index of &lt;start sequence&gt; token in decoder vocabulary.</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">    </span>:param end_id: Index of &lt;end sequence&gt; token in decoder vocabulary.</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">    </span>:param beam_width: Beam size. Default 4.</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">    </span>:param num_hypotheses: Number of hypotheses to generate. Default 1.</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">    </span>:param max_length: Length limit for generated sequence. Default 50.</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="syntax--string syntax--quoted"><span class="leading-whitespace">    </span>"""</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span><span class="syntax--keyword syntax--control">if</span> <span class="syntax--entity syntax--name syntax--function">isinstance</span>(X, list) <span class="syntax--keyword syntax--operator syntax--logical syntax--python">or</span> X.<span class="syntax--variable syntax--other syntax--object syntax--property">ndim</span> <span class="syntax--keyword syntax--operator">==</span> <span class="syntax--constant syntax--language">1</span>:</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>X <span class="syntax--keyword syntax--operator">=</span> np.<span class="syntax--entity syntax--name syntax--function">array</span>([X], <span class="syntax--variable syntax--parameter syntax--function">dtype</span><span class="syntax--keyword syntax--operator">=</span>np.<span class="syntax--variable syntax--other syntax--object syntax--property">int32</span>).<span class="syntax--variable syntax--other syntax--object syntax--property">T</span></span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span><span class="syntax--keyword syntax--other">assert</span> X.<span class="syntax--variable syntax--other syntax--object syntax--property">ndim</span> <span class="syntax--keyword syntax--operator">==</span> <span class="syntax--constant syntax--language">2</span> <span class="syntax--keyword syntax--operator syntax--logical syntax--python">and</span> X.<span class="syntax--variable syntax--other syntax--object syntax--property">shape</span>[<span class="syntax--constant syntax--language">1</span>] <span class="syntax--keyword syntax--operator">==</span> <span class="syntax--constant syntax--language">1</span>, <span class="syntax--string syntax--quoted">"X should be a column array with shape (input-sequence-length, 1)"</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span>next_fringe <span class="syntax--keyword syntax--operator">=</span> [<span class="syntax--entity syntax--name syntax--function">Node</span>(<span class="syntax--variable syntax--parameter syntax--function">parent</span><span class="syntax--keyword syntax--operator">=</span><span class="syntax--constant syntax--language">None</span>, <span class="syntax--variable syntax--parameter syntax--function">state</span><span class="syntax--keyword syntax--operator">=</span><span class="syntax--entity syntax--name syntax--function">initial_state_function</span>(X), <span class="syntax--variable syntax--parameter syntax--function">value</span><span class="syntax--keyword syntax--operator">=</span>start_id, <span class="syntax--variable syntax--parameter syntax--function">cost</span><span class="syntax--keyword syntax--operator">=</span><span class="syntax--constant syntax--language">0.0</span>, <span class="syntax--variable syntax--parameter syntax--function">extras</span><span class="syntax--keyword syntax--operator">=</span><span class="syntax--constant syntax--language">None</span>)]</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span>hypotheses <span class="syntax--keyword syntax--operator">=</span> []</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span><span class="syntax--keyword syntax--control">for</span> _ <span class="syntax--keyword syntax--operator syntax--logical syntax--python">in</span> <span class="syntax--entity syntax--name syntax--function">range</span>(max_length):</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>fringe <span class="syntax--keyword syntax--operator">=</span> []</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span><span class="syntax--keyword syntax--control">for</span> n <span class="syntax--keyword syntax--operator syntax--logical syntax--python">in</span> next_fringe:</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">            </span><span class="syntax--keyword syntax--control">if</span> n.<span class="syntax--variable syntax--other syntax--object syntax--property">value</span> <span class="syntax--keyword syntax--operator">==</span> end_id:</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">                </span>hypotheses.<span class="syntax--entity syntax--name syntax--function">append</span>(n)</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">            </span><span class="syntax--keyword syntax--control">else</span>:</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">                </span>fringe.<span class="syntax--entity syntax--name syntax--function">append</span>(n)</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span><span class="syntax--keyword syntax--control">if</span> <span class="syntax--keyword syntax--operator syntax--logical syntax--python">not</span> fringe <span class="syntax--keyword syntax--operator syntax--logical syntax--python">or</span> <span class="syntax--entity syntax--name syntax--function">len</span>(hypotheses) <span class="syntax--keyword syntax--operator">&gt;=</span> num_hypotheses:</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">            </span><span class="syntax--keyword syntax--control">break</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>Y_tm1 <span class="syntax--keyword syntax--operator">=</span> np.<span class="syntax--entity syntax--name syntax--function">array</span>([n.<span class="syntax--variable syntax--other syntax--object syntax--property">value</span> <span class="syntax--keyword syntax--control">for</span> n <span class="syntax--keyword syntax--operator syntax--logical syntax--python">in</span> fringe], <span class="syntax--variable syntax--parameter syntax--function">dtype</span><span class="syntax--keyword syntax--operator">=</span>np.<span class="syntax--variable syntax--other syntax--object syntax--property">int32</span>)</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>state_tm1 <span class="syntax--keyword syntax--operator">=</span> np.<span class="syntax--entity syntax--name syntax--function">array</span>([n.<span class="syntax--variable syntax--other syntax--object syntax--property">state</span> <span class="syntax--keyword syntax--control">for</span> n <span class="syntax--keyword syntax--operator syntax--logical syntax--python">in</span> fringe], <span class="syntax--variable syntax--parameter syntax--function">dtype</span><span class="syntax--keyword syntax--operator">=</span>np.<span class="syntax--variable syntax--other syntax--object syntax--property">float32</span>)</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>state_t, p_t, extras_t <span class="syntax--keyword syntax--operator">=</span> <span class="syntax--entity syntax--name syntax--function">generate_function</span>(X, Y_tm1, state_tm1)</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>Y_t <span class="syntax--keyword syntax--operator">=</span> np.<span class="syntax--entity syntax--name syntax--function">argsort</span>(p_t, <span class="syntax--variable syntax--parameter syntax--function">axis</span><span class="syntax--keyword syntax--operator">=</span><span class="syntax--constant syntax--language">1</span>)[:,<span class="syntax--keyword syntax--operator">-</span>beam_width:] <span class="syntax--comment syntax--line"># no point in taking more than fits in the beam</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>next_fringe <span class="syntax--keyword syntax--operator">=</span> []</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span><span class="syntax--keyword syntax--control">for</span> Y_t_n, p_t_n, extras_t_n, state_t_n, n <span class="syntax--keyword syntax--operator syntax--logical syntax--python">in</span> <span class="syntax--entity syntax--name syntax--function">zip</span>(Y_t, p_t, extras_t, state_t, fringe):</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">            </span>Y_nll_t_n <span class="syntax--keyword syntax--operator">=</span> <span class="syntax--keyword syntax--operator">-</span>np.<span class="syntax--entity syntax--name syntax--function">log</span>(p_t_n[Y_t_n])</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">            </span><span class="syntax--keyword syntax--control">for</span> y_t_n, y_nll_t_n <span class="syntax--keyword syntax--operator syntax--logical syntax--python">in</span> <span class="syntax--entity syntax--name syntax--function">zip</span>(Y_t_n, Y_nll_t_n):</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">                </span>n_new <span class="syntax--keyword syntax--operator">=</span> <span class="syntax--entity syntax--name syntax--function">Node</span>(<span class="syntax--variable syntax--parameter syntax--function">parent</span><span class="syntax--keyword syntax--operator">=</span>n, <span class="syntax--variable syntax--parameter syntax--function">state</span><span class="syntax--keyword syntax--operator">=</span>state_t_n, <span class="syntax--variable syntax--parameter syntax--function">value</span><span class="syntax--keyword syntax--operator">=</span>y_t_n, <span class="syntax--variable syntax--parameter syntax--function">cost</span><span class="syntax--keyword syntax--operator">=</span>y_nll_t_n, <span class="syntax--variable syntax--parameter syntax--function">extras</span><span class="syntax--keyword syntax--operator">=</span>extras_t_n)</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">                </span>next_fringe.<span class="syntax--entity syntax--name syntax--function">append</span>(n_new)</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">        </span>next_fringe <span class="syntax--keyword syntax--operator">=</span> <span class="syntax--entity syntax--name syntax--function">sorted</span>(next_fringe, <span class="syntax--variable syntax--parameter syntax--function">key</span><span class="syntax--keyword syntax--operator">=</span><span class="syntax--storage syntax--type syntax--function">lambda</span> n: n.<span class="syntax--variable syntax--other syntax--object syntax--property">cum_cost</span>)[:beam_width] <span class="syntax--comment syntax--line"># may move this into loop to save memory</span></span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span>hypotheses.<span class="syntax--entity syntax--name syntax--function">sort</span>(<span class="syntax--variable syntax--parameter syntax--function">key</span><span class="syntax--keyword syntax--operator">=</span><span class="syntax--storage syntax--type syntax--function">lambda</span> n: n.<span class="syntax--variable syntax--other syntax--object syntax--property">cum_cost</span>)</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span><span class="syntax--keyword syntax--control">return</span> hypotheses[:num_hypotheses]</span></span>
<span class=""></span> </pre>
<p>Usage example:</p>
<pre class="editor-colors lang-python"><span><span class="syntax--source syntax--python"><span class="syntax--keyword syntax--control">from</span> beam_search <span class="syntax--keyword syntax--control">import</span> beam_search</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--comment syntax--line"># Load model and vocabularies...</span></span></span>
<span class=""><span class="syntax--source syntax--python">input_text <span class="syntax--keyword syntax--operator">=</span> <span class="syntax--string syntax--quoted">"Hello World !"</span></span></span>
<span class=""><span class="syntax--source syntax--python">X <span class="syntax--keyword syntax--operator">=</span> [encoder_vocabulary.<span class="syntax--entity syntax--name syntax--function">get</span>(t, encoder_vocabulary[<span class="syntax--string syntax--quoted">'&lt;UNK&gt;'</span>]) <span class="syntax--keyword syntax--control">for</span> t <span class="syntax--keyword syntax--operator syntax--logical syntax--python">in</span> input_text.<span class="syntax--entity syntax--name syntax--function">split</span>()]</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python">hypotheses <span class="syntax--keyword syntax--operator">=</span> <span class="syntax--entity syntax--name syntax--function">beam_search</span>(model.<span class="syntax--variable syntax--other syntax--object syntax--property">initial_state_function</span>, model.<span class="syntax--variable syntax--other syntax--object syntax--property">generate_function</span>, X, decoder_vocabulary[<span class="syntax--string syntax--quoted">'&lt;S&gt;'</span>], decoder_vocabulary[<span class="syntax--string syntax--quoted">'&lt;/S&gt;'</span>])</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="syntax--keyword syntax--control">for</span> hypothesis <span class="syntax--keyword syntax--operator syntax--logical syntax--python">in</span> hypotheses:</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span>generated_indices <span class="syntax--keyword syntax--operator">=</span> hypothesis.<span class="syntax--entity syntax--name syntax--function">to_sequence_of_values</span>()</span></span>
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span>generated_tokens <span class="syntax--keyword syntax--operator">=</span> [reverse_decoder_vocabulary[i] <span class="syntax--keyword syntax--control">for</span> i <span class="syntax--keyword syntax--operator syntax--logical syntax--python">in</span> generated_indices]</span></span>
<span class=""></span> 
<span class=""><span class="syntax--source syntax--python"><span class="leading-whitespace">    </span><span class="syntax--entity syntax--name syntax--function">print</span>(<span class="syntax--string syntax--quoted">" "</span>.<span class="syntax--entity syntax--name syntax--function">join</span>(generated_tokens))`</span></span></pre>

  </body>
</html>
